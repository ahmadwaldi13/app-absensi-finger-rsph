select
utama.*,dke.*
from (
SELECT
	CONVERT(trim( nomor_mesin ),UNSIGNED INTEGER ) nomor_mesin,
	CONVERT(trim( id_user ),UNSIGNED INTEGER ) id_user,
	trim( username ) username,
	trim(nama_karyawan) nama_karyawan,
	trim(departemen_bidang) departemen_bidang,
	CONVERT(trim( kode_departemen_bidang ),UNSIGNED INTEGER ) kode_departemen_bidang,
	trim(ruangan) ruangan,
	CONVERT(trim( kode_ruangan ),UNSIGNED INTEGER ) kode_ruangan,
	CONVERT(trim( kode_jadwal ),UNSIGNED INTEGER ) kode_jadwal
FROM
	data_karyawan_tmp
where nama_karyawan is not null or nama_karyawan!=''
)utama
left join data_karyawan_excel dke on
dke.nomor_mesin=utama.nomor_mesin and
dke.id_user=utama.id_user and
dke.username=utama.username and
dke.nama_karyawan=utama.nama_karyawan and
dke.departemen_bidang=utama.departemen_bidang and
dke.ruangan=utama.ruangan
where dke.nomor_mesin is null
;

insert ignore into data_karyawan_excel(
	nomor_mesin,id_user,username,nama_karyawan,departemen_bidang,kode_departemen_bidang,ruangan,kode_ruangan,kode_jadwal
)
select
utama.*
from (
SELECT
	CONVERT(trim( nomor_mesin ),UNSIGNED INTEGER ) nomor_mesin,
	CONVERT(trim( id_user ),UNSIGNED INTEGER ) id_user,
	trim( username ) username,
	trim(nama_karyawan) nama_karyawan,
	trim(departemen_bidang) departemen_bidang,
	CONVERT(trim( kode_departemen_bidang ),UNSIGNED INTEGER ) kode_departemen_bidang,
	trim(ruangan) ruangan,
	CONVERT(trim( kode_ruangan ),UNSIGNED INTEGER ) kode_ruangan,
	CONVERT(trim( kode_jadwal ),UNSIGNED INTEGER ) kode_jadwal
FROM
	data_karyawan_tmp
where nama_karyawan is not null or nama_karyawan!=''
)utama
left join data_karyawan_excel dke on
dke.nomor_mesin=utama.nomor_mesin and
dke.id_user=utama.id_user and
dke.username=utama.username and
dke.nama_karyawan=utama.nama_karyawan and
dke.departemen_bidang=utama.departemen_bidang and
dke.ruangan=utama.ruangan
where dke.nomor_mesin is null;


ALTER TABLE sik_atam_absensi_master.ref_departemen AUTO_INCREMENT = 1;
insert ignore into sik_atam_absensi_master.ref_departemen(
	nm_departemen
)
select utama.departemen_bidang from (
	select trim(departemen_bidang) departemen_bidang,
	lcase(replace(trim(departemen_bidang),' ','') ) departemen_uniq

	from data_karyawan_tmp
	where departemen_bidang is not null or departemen_bidang!=''
	group by departemen_bidang
)utama

left join (
	select trim(nm_departemen) nm_departemen,
	lcase(replace(trim(nm_departemen),' ','') ) departemen_uniq

	from sik_atam_absensi_master.ref_departemen
	where nm_departemen is not null or nm_departemen!=''
	group by nm_departemen
)target on utama.departemen_uniq=target.departemen_uniq
where target.departemen_uniq is null



ALTER TABLE sik_atam_absensi_master.ref_ruangan AUTO_INCREMENT = 1;
insert ignore into sik_atam_absensi_master.ref_ruangan(
	id_departemen,nm_ruangan
)
select
utama.id_departemen,
ruangan
from (
	select utama.*,id_departemen from (
		select
			trim(departemen_bidang) departemen_bidang,
			lcase(replace(trim(departemen_bidang),' ','') ) departemen_uniq,
			trim(ruangan) ruangan,
			lcase(replace(trim(ruangan),' ','') ) ruangan_uniq
		from data_karyawan_tmp
		where ruangan is not null or ruangan!=''
		group by ruangan
	)utama
	left join (
		select
			id_departemen,
			lcase(replace(trim(nm_departemen),' ','') ) departemen_uniq
		from sik_atam_absensi_master.ref_departemen
		where nm_departemen is not null or nm_departemen!=''
		group by nm_departemen
	)departemen on departemen.departemen_uniq=utama.departemen_uniq
)utama

left join (
	select
	id_departemen,
	trim(nm_ruangan) nm_ruangan,
	lcase(replace(trim(nm_ruangan),' ','') ) ruangan_uniq
	from sik_atam_absensi_master.ref_ruangan
	where nm_ruangan is not null or nm_ruangan!=''
	group by nm_ruangan
)target on utama.ruangan_uniq=target.ruangan_uniq
where target.ruangan_uniq is null
;





ALTER TABLE sik_atam_absensi_master.ref_karyawan AUTO_INCREMENT = 1;
insert ignore into sik_atam_absensi_master.ref_karyawan(
	nm_karyawan,alamat,nip,id_jabatan,id_departemen,id_ruangan
)
select
utama.nm_karyawan,
utama.alamat,
utama.nip,
1 id_jabatan,
departemen.id_departemen,
ruangan.id_ruangan
from(
	select
	CONVERT(trim( nomor_mesin ),UNSIGNED INTEGER ) nomor_mesin,
	CONVERT(trim( id_user ),UNSIGNED INTEGER ) id_user,
	trim( username ) username,
	trim(nama_karyawan) nm_karyawan,
	lcase(replace(trim(nama_karyawan),' ','') ) nm_karyawan_uniq,
	trim(departemen_bidang) departemen_bidang,
	lcase(replace(trim(departemen_bidang),' ','') ) departemen_uniq,
	trim(ruangan) ruangan,
	lcase(replace(trim(ruangan),' ','') ) ruangan_uniq,
	CONVERT(trim( kode_ruangan ),UNSIGNED INTEGER ) kode_ruangan,
	CONVERT(trim( kode_jadwal ),UNSIGNED INTEGER ) kode_jadwal,
	trim(alamat) alamat,
	trim(nip) nip
	from
	data_karyawan_excel utama
)utama
left join (
select
	id_karyawan,
	nm_karyawan,
	lcase(replace(trim(nm_karyawan),' ','') ) nm_karyawan_uniq
from sik_atam_absensi_master.ref_karyawan
)karyawan on karyawan.nm_karyawan_uniq=utama.nm_karyawan_uniq

left join (
	select
		id_departemen,
		trim(nm_departemen) nm_departemen,
		lcase(replace(trim(nm_departemen),' ','') ) departemen_uniq
	from sik_atam_absensi_master.ref_departemen
	where nm_departemen is not null or nm_departemen!=''
	group by nm_departemen
)departemen on departemen.departemen_uniq=utama.departemen_uniq

left join (
	select
	id_departemen,
	id_ruangan,
	trim(nm_ruangan) nm_ruangan,
	lcase(replace(trim(nm_ruangan),' ','') ) ruangan_uniq
	from sik_atam_absensi_master.ref_ruangan
	where nm_ruangan is not null or nm_ruangan!=''
	group by nm_ruangan
)ruangan on departemen.id_departemen=ruangan.id_departemen and ruangan.ruangan_uniq=utama.ruangan_uniq

where
karyawan.id_karyawan is null
;




ALTER TABLE sik_atam_absensi_master.ref_karyawan_jadwal AUTO_INCREMENT = 1;
insert ignore into sik_atam_absensi_master.ref_karyawan_jadwal(
	id_karyawan,id_jenis_jadwal
)

select
karyawan.id_karyawan,
kode_jadwal
from(
	select
	CONVERT(trim( nomor_mesin ),UNSIGNED INTEGER ) nomor_mesin,
	CONVERT(trim( id_user ),UNSIGNED INTEGER ) id_user,
	trim( username ) username,
	trim(nama_karyawan) nm_karyawan,
	lcase(replace(trim(nama_karyawan),' ','') ) nm_karyawan_uniq,
	trim(departemen_bidang) departemen_bidang,
	lcase(replace(trim(departemen_bidang),' ','') ) departemen_uniq,
	trim(ruangan) ruangan,
	lcase(replace(trim(ruangan),' ','') ) ruangan_uniq,
	CONVERT(trim( kode_ruangan ),UNSIGNED INTEGER ) kode_ruangan,
	CONVERT(trim( kode_jadwal ),UNSIGNED INTEGER ) kode_jadwal,
	trim(alamat) alamat,
	trim(nip) nip
	from
	data_karyawan_excel utama
)utama
left join (
select
	id_karyawan,
	nm_karyawan,
	lcase(replace(trim(nm_karyawan),' ','') ) nm_karyawan_uniq
from sik_atam_absensi_master.ref_karyawan
)karyawan on karyawan.nm_karyawan_uniq=utama.nm_karyawan_uniq
where
karyawan.id_karyawan is not null
;

ALTER TABLE sik_atam_absensi_master.ref_karyawan_user AUTO_INCREMENT = 1;
insert ignore into sik_atam_absensi_master.ref_karyawan_user(
	id_karyawan,id_user
)

select
karyawan.id_karyawan,
id_user
from(
	select
	CONVERT(trim( nomor_mesin ),UNSIGNED INTEGER ) nomor_mesin,
	CONVERT(trim( id_user ),UNSIGNED INTEGER ) id_user,
	trim( username ) username,
	trim(nama_karyawan) nm_karyawan,
	lcase(replace(trim(nama_karyawan),' ','') ) nm_karyawan_uniq,
	trim(departemen_bidang) departemen_bidang,
	lcase(replace(trim(departemen_bidang),' ','') ) departemen_uniq,
	trim(ruangan) ruangan,
	lcase(replace(trim(ruangan),' ','') ) ruangan_uniq,
	CONVERT(trim( kode_ruangan ),UNSIGNED INTEGER ) kode_ruangan,
	CONVERT(trim( kode_jadwal ),UNSIGNED INTEGER ) kode_jadwal,
	trim(alamat) alamat,
	trim(nip) nip
	from
	data_karyawan_excel utama
)utama
left join (
select
	id_karyawan,
	nm_karyawan,
	lcase(replace(trim(nm_karyawan),' ','') ) nm_karyawan_uniq
from sik_atam_absensi_master.ref_karyawan
)karyawan on karyawan.nm_karyawan_uniq=utama.nm_karyawan_uniq
where
karyawan.id_karyawan is not null
;